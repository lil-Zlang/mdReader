<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>skimmd</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;600&family=JetBrains+Mono:wght@400;600&display=swap");

      :root {
        color-scheme: light;
        --bg: #f7f6f3;
        --bg-strong: #f1f1ee;
        --panel: #ffffff;
        --panel-strong: #ffffff;
        --ink: #2f3437;
        --muted: #787774;
        --accent: #2f6fed;
        --accent-strong: #1d4ed8;
        --accent-soft: #e9f0ff;
        --border: #e3e3e0;
        --border-strong: #d7d7d2;
        --code-bg: #f7f6f3;
        --code-ink: #2f3437;
        --shadow: 0 10px 24px rgba(15, 15, 14, 0.08);
        --shadow-soft: 0 6px 14px rgba(15, 15, 14, 0.06);
        --radius: 12px;
        --radius-sm: 8px;
        --font-ui: "Source Sans 3", "Trebuchet MS", sans-serif;
        --font-body: "Source Sans 3", "Trebuchet MS", sans-serif;
        --font-mono: "JetBrains Mono", "SFMono-Regular", monospace;
        --hover-bg: #efefec;
        --toc-active: #e8e7e4;
        --folder-bg: #fbfbfa;
        --pill-bg: #ededeb;
        --inline-code-bg: #f1f1ef;
        --inline-code-ink: #2f3437;
        --blockquote-bg: #fbfbfa;
        --editing-bg: #fbfbfa;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #1a1a1a;
        --bg-strong: #222222;
        --panel: #252525;
        --panel-strong: #2a2a2a;
        --ink: #e4e4e4;
        --muted: #888888;
        --accent: #5b9aff;
        --accent-strong: #7db0ff;
        --accent-soft: #1e3a5f;
        --border: #3a3a3a;
        --border-strong: #4a4a4a;
        --code-bg: #2a2a2a;
        --code-ink: #e4e4e4;
        --shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
        --shadow-soft: 0 6px 14px rgba(0, 0, 0, 0.2);
        --hover-bg: #333333;
        --toc-active: #3a3a3a;
        --folder-bg: #2a2a2a;
        --pill-bg: #333333;
        --inline-code-bg: #333333;
        --inline-code-ink: #e4e4e4;
        --blockquote-bg: #2a2a2a;
        --editing-bg: #2a2a2a;
      }

      @media (prefers-color-scheme: dark) {
        [data-theme="system"] {
          color-scheme: dark;
          --bg: #1a1a1a;
          --bg-strong: #222222;
          --panel: #252525;
          --panel-strong: #2a2a2a;
          --ink: #e4e4e4;
          --muted: #888888;
          --accent: #5b9aff;
          --accent-strong: #7db0ff;
          --accent-soft: #1e3a5f;
          --border: #3a3a3a;
          --border-strong: #4a4a4a;
          --code-bg: #2a2a2a;
          --code-ink: #e4e4e4;
          --shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
          --shadow-soft: 0 6px 14px rgba(0, 0, 0, 0.2);
          --hover-bg: #333333;
          --toc-active: #3a3a3a;
          --folder-bg: #2a2a2a;
          --pill-bg: #333333;
          --inline-code-bg: #333333;
          --inline-code-ink: #e4e4e4;
          --blockquote-bg: #2a2a2a;
          --editing-bg: #2a2a2a;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: var(--font-ui);
        background: var(--bg);
        color: var(--ink);
        min-height: 100vh;
      }

      .app {
        display: grid;
        grid-template-columns: minmax(240px, 320px) 1fr;
        min-height: 100vh;
        gap: 16px;
        padding: 20px;
      }

      .sidebar {
        background: var(--bg);
        border-radius: var(--radius);
        padding: 18px 16px 14px;
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        gap: 14px;
        min-height: 0;
        border: 1px solid var(--border);
      }

      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .logo {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .pill {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 5px 9px;
        border-radius: 999px;
        background: var(--pill-bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .folder {
        font-size: 12px;
        color: var(--muted);
        background: var(--folder-bg);
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        word-break: break-all;
      }

      .search {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filter {
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
        background: var(--panel-strong);
        color: var(--ink);
        font-family: var(--font-ui);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .filter::placeholder {
        color: var(--muted);
      }

      .filter:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(47, 111, 237, 0.15);
      }

      .search-hint {
        font-size: 11px;
        color: var(--muted);
        background: var(--pill-bg);
        border-radius: 8px;
        padding: 4px 6px;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-height: 0;
      }

      .file-item {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease;
        background: transparent;
        font-size: 13px;
        color: var(--ink);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-item:hover {
        background: var(--hover-bg);
      }

      .file-item.active {
        background: var(--accent);
        color: #fff;
      }

      .sidebar-footer {
        font-size: 11px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        border-top: 1px solid var(--border);
        padding-top: 10px;
      }

      .viewer {
        background: var(--panel);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
        max-height: 100vh;
        border: 1px solid var(--border);
      }

      .viewer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .meta-wrap {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .meta-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .meta {
        font-size: 13px;
        color: var(--muted);
      }

      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .button {
        border: 1px solid var(--border);
        background: var(--panel);
        padding: 7px 14px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        font-family: var(--font-ui);
        color: var(--ink);
      }

      .button:hover {
        border-color: var(--border-strong);
        background: var(--hover-bg);
        color: var(--ink);
      }

      .button.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      .button.primary:hover {
        color: #fff;
        background: var(--accent-strong);
        border-color: var(--accent-strong);
      }

      .button.secondary {
        background: var(--bg-strong);
      }

      .button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .viewer-body {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 260px;
        gap: 16px;
        min-height: 0;
        overflow-y: auto;
        flex: 1;
      }

      .doc-header {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .doc-title {
        font-size: 22px;
        font-weight: 700;
      }

      .doc-path {
        font-size: 12px;
        color: var(--muted);
      }

      .content {
        flex: 1;
        background: var(--panel-strong);
        border-radius: var(--radius-sm);
        padding: 20px 22px 28px;
        border: 1px solid var(--border);
        font-family: var(--font-body);
        font-size: 16px;
        line-height: 1.7;
      }

      .content.editing {
        border: 1px solid var(--accent);
        box-shadow: inset 0 0 0 1px rgba(47, 111, 237, 0.2);
        background: var(--editing-bg);
      }

      .content.editing:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px rgba(47, 111, 237, 0.25);
      }

      .content h1,
      .content h2,
      .content h3 {
        font-family: var(--font-ui);
        margin-top: 1.8em;
      }

      .content h1 {
        font-size: 28px;
      }

      .content h2 {
        font-size: 22px;
      }

      .content h3 {
        font-size: 18px;
      }

      .content a {
        color: var(--accent);
      }

      .content pre {
        background: var(--code-bg);
        color: var(--code-ink);
        padding: 14px 16px;
        border-radius: 10px;
        overflow-x: auto;
        border: 1px solid var(--border);
        box-shadow: none;
      }

      .content code {
        font-family: var(--font-mono);
        font-size: 0.95em;
      }

      .content :not(pre) > code {
        background: var(--inline-code-bg);
        color: var(--inline-code-ink);
        border-radius: 6px;
        padding: 2px 6px;
        border: 1px solid var(--border);
      }

      .content blockquote {
        margin: 1.5em 0;
        padding: 10px 16px;
        border-left: 3px solid var(--border-strong);
        background: var(--blockquote-bg);
        border-radius: 8px;
      }

      .content table {
        border-collapse: collapse;
        width: 100%;
        margin: 1.5em 0;
        font-size: 15px;
      }

      .content th,
      .content td {
        border: 1px solid var(--border);
        padding: 8px 10px;
        text-align: left;
      }

      .content img {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: none;
      }

      .empty {
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .side-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
        position: sticky;
        top: 20px;
        align-self: start;
      }

      .toc,
      .inspector {
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: var(--folder-bg);
      }

      .toc-title,
      .inspector-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
      }

      .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 6px;
      }

      .toc-item {
        font-size: 13px;
        cursor: pointer;
        color: var(--ink);
        padding: 6px 8px;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .toc-item:hover {
        background: var(--hover-bg);
      }

      .toc-item.active {
        background: var(--toc-active);
        color: var(--ink);
      }

      .toc-item.level-2 {
        padding-left: 18px;
        color: var(--muted);
      }

      .toc-item.level-3 {
        padding-left: 28px;
        color: var(--muted);
      }

      .inspector-text {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.5;
      }

      .badge {
        align-self: flex-start;
        font-size: 12px;
        font-weight: 600;
        padding: 5px 9px;
        border-radius: 999px;
        background: var(--pill-bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }

      body.editing .badge {
        background: var(--accent-soft);
        color: var(--accent-strong);
        border-color: var(--accent-soft);
      }

      .hidden {
        display: none;
      }

      /* Formatting Toolbar */
      .format-toolbar {
        display: none;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      body.editing .format-toolbar {
        display: flex;
      }

      .format-toolbar .divider {
        width: 1px;
        height: 20px;
        background: var(--border);
        margin: 0 6px;
      }

      .format-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--ink);
        font-family: var(--font-ui);
        font-size: 14px;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .format-btn:hover {
        background: var(--hover-bg);
      }

      .format-btn.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .format-btn svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .format-btn.bold {
        font-weight: 700;
      }

      .format-btn.italic {
        font-style: italic;
      }

      .format-btn.strike {
        text-decoration: line-through;
      }

      .format-dropdown {
        position: relative;
      }

      .format-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--ink);
        font-family: var(--font-ui);
        font-size: 13px;
        transition: background 0.15s ease;
      }

      .format-dropdown-btn:hover {
        background: var(--hover-bg);
      }

      .format-dropdown-btn svg {
        width: 12px;
        height: 12px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .format-dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 4px;
        min-width: 140px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow);
        z-index: 100;
        padding: 4px;
      }

      .format-dropdown.open .format-dropdown-menu {
        display: block;
      }

      .format-dropdown-item {
        display: block;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        color: var(--ink);
        font-family: var(--font-ui);
        font-size: 13px;
        text-align: left;
        transition: background 0.15s ease;
      }

      .format-dropdown-item:hover {
        background: var(--hover-bg);
      }

      .format-dropdown-item.h1 {
        font-size: 18px;
        font-weight: 700;
      }

      .format-dropdown-item.h2 {
        font-size: 16px;
        font-weight: 600;
      }

      .format-dropdown-item.h3 {
        font-size: 14px;
        font-weight: 600;
      }

      .word-count {
        margin-left: auto;
        font-size: 12px;
        color: var(--muted);
        padding: 0 8px;
      }

      /* Width toggle buttons */
      .width-toggle {
        display: flex;
        gap: 2px;
        padding: 2px;
        background: var(--pill-bg);
        border-radius: 6px;
        border: 1px solid var(--border);
      }

      .width-btn {
        padding: 4px 8px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        color: var(--muted);
        transition: background 0.15s ease, color 0.15s ease;
        font-family: var(--font-ui);
      }

      .width-btn:hover {
        color: var(--ink);
      }

      .width-btn.active {
        background: var(--panel);
        color: var(--ink);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }

      /* Focus button */
      .focus-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--muted);
        font-family: var(--font-ui);
        font-size: 12px;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .focus-btn:hover {
        background: var(--hover-bg);
        color: var(--ink);
      }

      .focus-btn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .focus-btn .exit-icon,
      .focus-btn .exit-text {
        display: none;
      }

      body.focus-mode .focus-btn .focus-icon,
      body.focus-mode .focus-btn .focus-text {
        display: none;
      }

      body.focus-mode .focus-btn .exit-icon,
      body.focus-mode .focus-btn .exit-text {
        display: inline;
      }

      /* Document section */
      .document {
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      /* Format toolbar - positioned outside scroll area so it stays fixed */
      body.editing .format-toolbar {
        display: flex;
        z-index: 50;
        box-shadow: var(--shadow-soft);
        flex-shrink: 0;
      }

      /* Focus mode */
      body.focus-mode .app {
        grid-template-columns: 1fr;
      }

      body.focus-mode .sidebar {
        display: none;
      }

      body.focus-mode .viewer-body {
        grid-template-columns: minmax(0, 1fr) 260px;
      }

      body.focus-mode .viewer {
        max-width: 100%;
        border: none;
        box-shadow: none;
        border-radius: 0;
      }

      body.focus-mode .viewer-header {
        display: none;
      }

      body.focus-mode .doc-header {
        display: none;
      }

      body.focus-mode .inspector {
        display: none;
      }

      /* Content width modes - only apply in editing mode */
      body.editing .content.fixed-width {
        max-width: 720px;
        margin: 0 auto;
      }

      body.editing .content.full-width {
        max-width: none;
      }

      .theme-toggle {
        display: flex;
        gap: 4px;
        padding: 3px;
        background: var(--pill-bg);
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .theme-btn {
        padding: 4px 8px;
        border: none;
        background: transparent;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        color: var(--muted);
        transition: background 0.15s ease, color 0.15s ease;
        font-family: var(--font-ui);
      }

      .theme-btn:hover {
        color: var(--ink);
      }

      .theme-btn.active {
        background: var(--panel);
        color: var(--ink);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 1100px) {
        .viewer-body {
          grid-template-columns: 1fr;
        }

        .side-panel {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .toc,
        .inspector {
          flex: 1 1 260px;
        }
      }

      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
          padding: 20px;
        }

        .viewer {
          padding: 20px;
        }
      }

      @media (max-width: 600px) {
        .content {
          padding: 18px;
        }

        .viewer-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      /* File browser modal */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 200;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.open {
        display: flex;
      }

      .modal {
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .modal-close:hover {
        background: var(--hover-bg);
        color: var(--ink);
      }

      .modal-close svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .path-input-wrap {
        display: flex;
        gap: 8px;
      }

      .path-input {
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        background: var(--panel-strong);
        color: var(--ink);
        font-family: var(--font-mono);
        outline: none;
      }

      .path-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(47, 111, 237, 0.15);
      }

      .path-go-btn {
        padding: 10px 16px;
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-family: var(--font-ui);
        transition: background 0.15s ease;
      }

      .path-go-btn:hover {
        background: var(--accent-strong);
      }

      .browser-nav {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--folder-bg);
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .browser-back {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .browser-back:hover {
        background: var(--hover-bg);
        color: var(--ink);
      }

      .browser-back svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .browser-path {
        flex: 1;
        font-size: 12px;
        color: var(--muted);
        font-family: var(--font-mono);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .browser-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-height: 300px;
        overflow-y: auto;
      }

      .browser-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .browser-item:hover {
        background: var(--hover-bg);
      }

      .browser-item svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
        flex-shrink: 0;
        color: var(--muted);
      }

      .browser-item.folder svg {
        color: var(--accent);
      }

      .browser-item-name {
        flex: 1;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .browser-empty {
        padding: 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }

      .open-file-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 10px;
        border: 1px dashed var(--border);
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: var(--muted);
        font-family: var(--font-ui);
        transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        margin-bottom: 8px;
      }

      .open-file-btn:hover {
        background: var(--hover-bg);
        border-color: var(--accent);
        color: var(--accent);
      }

      .open-file-btn svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }
    </style>
  </head>
  <body>
    <!-- File browser modal -->
    <div class="modal-overlay" id="file-modal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Open File</div>
          <button class="modal-close" id="modal-close">
            <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="path-input-wrap">
            <input type="text" class="path-input" id="path-input" placeholder="Paste file path or type to search...">
            <button class="path-go-btn" id="path-go-btn">Open</button>
          </div>
          <div class="browser-nav">
            <button class="browser-back" id="browser-back" title="Go up">
              <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="browser-path" id="browser-path">~</div>
          </div>
          <ul class="browser-list" id="browser-list"></ul>
        </div>
      </div>
    </div>

    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <div class="logo">skimmd</div>
          <div class="pill" id="file-count">0 files</div>
        </div>
        <div class="folder" id="folder"></div>
        <button class="open-file-btn" id="open-file-btn">
          <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
          Open File...
        </button>
        <div class="search">
          <input class="filter" id="filter" placeholder="Filter files..." />
          <div class="search-hint">Cmd+K</div>
        </div>
        <ul class="file-list" id="file-list"></ul>
        <div class="sidebar-footer">
          <div class="theme-toggle">
            <button class="theme-btn" data-theme="light">Light</button>
            <button class="theme-btn" data-theme="dark">Dark</button>
            <button class="theme-btn" data-theme="system">Auto</button>
          </div>
        </div>
      </aside>
      <main class="viewer">
        <div class="viewer-header">
          <div class="meta-wrap">
            <div class="meta-label">Current file</div>
            <div class="meta" id="meta">Select a file to start.</div>
          </div>
          <div class="toolbar">
            <button class="button" id="edit-toggle" disabled>Edit</button>
            <button class="button primary hidden" id="save">Save</button>
            <button class="button secondary hidden" id="cancel">Cancel</button>
          </div>
        </div>
        <div class="format-toolbar" id="format-toolbar">
              <button class="format-btn bold" data-cmd="bold" title="Bold (Cmd+B)">B</button>
              <button class="format-btn italic" data-cmd="italic" title="Italic (Cmd+I)">I</button>
              <button class="format-btn strike" data-cmd="strikeThrough" title="Strikethrough">S</button>
              <div class="divider"></div>
              <div class="format-dropdown" id="heading-dropdown">
                <button class="format-dropdown-btn" id="heading-btn">
                  <span id="heading-label">Body</span>
                  <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="format-dropdown-menu">
                  <button class="format-dropdown-item h1" data-heading="h1">Heading 1</button>
                  <button class="format-dropdown-item h2" data-heading="h2">Heading 2</button>
                  <button class="format-dropdown-item h3" data-heading="h3">Heading 3</button>
                  <button class="format-dropdown-item" data-heading="p">Body</button>
                </div>
              </div>
              <div class="divider"></div>
              <button class="format-btn" data-cmd="formatBlock" data-value="blockquote" title="Blockquote">
                <svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21z"></path><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"></path></svg>
              </button>
              <button class="format-btn" data-cmd="insertUnorderedList" title="Bullet List">
                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><circle cx="4" cy="6" r="1" fill="currentColor"></circle><circle cx="4" cy="12" r="1" fill="currentColor"></circle><circle cx="4" cy="18" r="1" fill="currentColor"></circle></svg>
              </button>
              <button class="format-btn" data-cmd="insertOrderedList" title="Numbered List">
                <svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><text x="4" y="7" font-size="6" fill="currentColor" stroke="none">1</text><text x="4" y="13" font-size="6" fill="currentColor" stroke="none">2</text><text x="4" y="19" font-size="6" fill="currentColor" stroke="none">3</text></svg>
              </button>
              <div class="divider"></div>
              <button class="format-btn" id="link-btn" title="Insert Link (Cmd+K)">
                <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
              </button>
              <div class="divider"></div>
              <div class="format-dropdown" id="insert-dropdown">
                <button class="format-dropdown-btn">
                  <span>Insert</span>
                  <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="format-dropdown-menu">
                  <button class="format-dropdown-item" data-insert="code">Code Block</button>
                  <button class="format-dropdown-item" data-insert="hr">Horizontal Rule</button>
                  <button class="format-dropdown-item" data-insert="table">Table</button>
                </div>
              </div>
              <div class="divider"></div>
              <div class="width-toggle" id="width-toggle">
                <button class="width-btn active" data-width="fixed" title="Fixed width">Fixed</button>
                <button class="width-btn" data-width="full" title="Full width">Full</button>
              </div>
              <button class="focus-btn" id="focus-btn" title="Focus mode (Esc to exit)">
                <svg class="focus-icon" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                <svg class="exit-icon" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
                <span class="focus-text">Focus</span>
                <span class="exit-text">Exit</span>
              </button>
              <div class="word-count" id="word-count">0 words</div>
            </div>
        <div class="viewer-body">
          <section class="document">
            <div class="doc-header">
              <div class="doc-title" id="doc-title">No file selected</div>
              <div class="doc-path" id="doc-path"></div>
            </div>
            <div id="content" class="content empty">Select a file to preview.</div>
          </section>
          <aside class="side-panel">
            <section class="toc">
              <div class="toc-title">Contents</div>
              <ul class="toc-list" id="toc-list"></ul>
            </section>
            <section class="inspector">
              <div class="inspector-title">Editing</div>
              <div class="inspector-text">
                Edit directly in the reader. The table of contents updates as you type.
              </div>
              <div class="badge" id="edit-badge">Read only</div>
            </section>
          </aside>
        </div>
      </main>
    </div>

    <script>
      // Theme handling
      function getStoredTheme() {
        return localStorage.getItem('skimmd-theme') || 'system';
      }

      function setTheme(theme) {
        localStorage.setItem('skimmd-theme', theme);
        document.documentElement.setAttribute('data-theme', theme);
        updateThemeButtons(theme);
      }

      function updateThemeButtons(theme) {
        document.querySelectorAll('.theme-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.theme === theme);
        });
      }

      // Apply theme immediately to prevent flash
      document.documentElement.setAttribute('data-theme', getStoredTheme());

      const state = {
        files: [],
        selectedId: null,
        filter: "",
        isEditing: false,
        currentContent: "",
        currentHtml: "",
        tocHeadings: [],
        openedFile: null, // For files opened via file browser (absolute path)
        browserPath: "",
      };

      const fileListEl = document.getElementById("file-list");
      const contentEl = document.getElementById("content");
      const folderEl = document.getElementById("folder");
      const metaEl = document.getElementById("meta");
      const filterEl = document.getElementById("filter");
      const editToggleEl = document.getElementById("edit-toggle");
      const saveEl = document.getElementById("save");
      const cancelEl = document.getElementById("cancel");
      const tocListEl = document.getElementById("toc-list");
      const fileCountEl = document.getElementById("file-count");
      const docTitleEl = document.getElementById("doc-title");
      const docPathEl = document.getElementById("doc-path");
      const editBadgeEl = document.getElementById("edit-badge");
      const viewerBodyEl = document.querySelector(".viewer-body");
      const formatToolbarEl = document.getElementById("format-toolbar");
      const wordCountEl = document.getElementById("word-count");
      const headingDropdown = document.getElementById("heading-dropdown");
      const headingLabel = document.getElementById("heading-label");
      const insertDropdown = document.getElementById("insert-dropdown");
      const linkBtn = document.getElementById("link-btn");
      const widthToggle = document.getElementById("width-toggle");
      const focusBtn = document.getElementById("focus-btn");
      const openFileBtnEl = document.getElementById("open-file-btn");
      const fileModal = document.getElementById("file-modal");
      const modalCloseBtn = document.getElementById("modal-close");
      const pathInput = document.getElementById("path-input");
      const pathGoBtn = document.getElementById("path-go-btn");
      const browserBackBtn = document.getElementById("browser-back");
      const browserPathEl = document.getElementById("browser-path");
      const browserListEl = document.getElementById("browser-list");

      let tocTimer = null;
      let scrollRaf = null;
      let activeTocId = null;

      async function fetchConfig() {
        try {
          const res = await fetch("/api/config");
          if (!res.ok) return;
          const data = await res.json();
          if (data.folderPath) {
            folderEl.textContent = data.folderPath;
          }
        } catch (err) {
          console.error("Failed to load config", err);
        }
      }

      async function fetchFiles() {
        const res = await fetch("/api/files");
        if (!res.ok) {
          contentEl.textContent = "Failed to load files.";
          return;
        }
        state.files = await res.json();
        renderList();
        selectInitialFile();
      }

      function updateFileCount(filteredCount) {
        const total = state.files.length;
        const label = filteredCount === total ? `${total}` : `${filteredCount} of ${total}`;
        const suffix = total === 1 ? "file" : "files";
        fileCountEl.textContent = `${label} ${suffix}`;
      }

      function renderList() {
        fileListEl.innerHTML = "";
        const filter = state.filter.trim().toLowerCase();
        const filtered = state.files.filter((file) => {
          if (!filter) return true;
          return (
            file.name.toLowerCase().includes(filter) ||
            file.relativePath.toLowerCase().includes(filter)
          );
        });

        updateFileCount(filtered.length);

        if (filtered.length === 0) {
          const empty = document.createElement("li");
          empty.className = "file-item";
          empty.textContent = "No matching files";
          fileListEl.appendChild(empty);
          return;
        }

        filtered.forEach((file) => {
          const item = document.createElement("li");
          item.className = "file-item" + (file.id === state.selectedId ? " active" : "");
          item.dataset.fileId = file.id;
          item.textContent = file.name;
          item.title = file.relativePath;

          item.addEventListener("click", () => {
            openFile(file.id);
          });

          fileListEl.appendChild(item);
        });
      }

      function updateDocHeader(file) {
        if (!file) {
          docTitleEl.textContent = "No file selected";
          docPathEl.textContent = "";
          document.title = "skimmd";
          return;
        }
        const displayName = file.name.replace(/\.md$/i, "");
        docTitleEl.textContent = displayName || "Untitled";
        docPathEl.textContent = file.relativePath || "";
        document.title = displayName ? `${displayName} - skimmd` : "mdr";
      }

      async function openFile(fileId) {
        state.selectedId = fileId;
        state.openedFile = null; // Clear externally opened file
        renderList();
        setEditMode(false);
        metaEl.textContent = "";
        contentEl.textContent = "Loading...";
        activeTocId = null;

        const file = state.files.find((item) => item.id === fileId);
        updateDocHeader(file);

        const res = await fetch(`/api/file?path=${encodeURIComponent(fileId)}`);
        if (!res.ok) {
          contentEl.textContent = "Failed to load file.";
          editToggleEl.disabled = true;
          return;
        }
        const data = await res.json();
        state.currentContent = data.content || "";
        state.currentHtml = data.html || "";
        contentEl.classList.remove("empty");
        contentEl.innerHTML = state.currentHtml;
        editToggleEl.disabled = false;
        if (data.metadata) {
          const updated = new Date(data.metadata.modifiedAt).toLocaleString();
          metaEl.textContent = `Last updated ${updated}`;
        }
        buildToc(contentEl);
      }

      function selectInitialFile() {
        if (state.selectedId || state.files.length === 0) return;
        const params = new URLSearchParams(window.location.search);
        const target = params.get("file");
        if (target) {
          const match = state.files.find((file) => {
            return (
              file.id === target ||
              file.relativePath === target ||
              file.name === target ||
              file.relativePath.endsWith("/" + target)
            );
          });
          if (match) {
            openFile(match.id);
            return;
          }
        }
        openFile(state.files[0].id);
      }

      function setEditMode(enabled) {
        state.isEditing = enabled;
        document.body.classList.toggle("editing", enabled);
        editBadgeEl.textContent = enabled ? "Editing" : "Read only";
        if (enabled) {
          contentEl.contentEditable = "true";
          contentEl.classList.add("editing");
          editToggleEl.classList.add("hidden");
          saveEl.classList.remove("hidden");
          cancelEl.classList.remove("hidden");
          updateWordCount();
          headingLabel.textContent = "Body";
        } else {
          contentEl.contentEditable = "false";
          contentEl.classList.remove("editing");
          editToggleEl.classList.remove("hidden");
          saveEl.classList.add("hidden");
          cancelEl.classList.add("hidden");
        }
      }

      function updateWordCount() {
        const text = contentEl.innerText || "";
        const words = text.trim().split(/\s+/).filter(w => w.length > 0);
        const count = words.length;
        wordCountEl.textContent = `${count} ${count === 1 ? 'word' : 'words'}`;
      }

      async function saveFile() {
        // Handle externally opened files
        if (state.openedFile) {
          return saveExternalFile();
        }

        if (!state.selectedId) return;
        const html = contentEl.innerHTML;
        saveEl.disabled = true;
        try {
          const res = await fetch(`/api/file?path=${encodeURIComponent(state.selectedId)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ html }),
          });
          if (!res.ok) {
            alert("Failed to save file");
            return;
          }
          const data = await res.json();
          state.currentContent = data.content || "";
          state.currentHtml = data.html || html;
          contentEl.innerHTML = state.currentHtml;
          if (data.metadata) {
            const updated = new Date(data.metadata.modifiedAt).toLocaleString();
            metaEl.textContent = `Last updated ${updated}`;
          }
          buildToc(contentEl);
          setEditMode(false);
        } finally {
          saveEl.disabled = false;
        }
      }

      function scheduleTocRefresh() {
        clearTimeout(tocTimer);
        tocTimer = setTimeout(() => buildToc(contentEl), 250);
      }

      function slugify(text) {
        const base = text
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        return base || "section";
      }

      function setActiveToc(id) {
        if (!id || id === activeTocId) return;
        const prev = activeTocId
          ? tocListEl.querySelector(`[data-toc-id="${CSS.escape(activeTocId)}"]`)
          : null;
        if (prev) {
          prev.classList.remove("active");
        }
        const next = tocListEl.querySelector(`[data-toc-id="${CSS.escape(id)}"]`);
        if (next) {
          next.classList.add("active");
          const listRect = tocListEl.getBoundingClientRect();
          const itemRect = next.getBoundingClientRect();
          if (itemRect.top < listRect.top || itemRect.bottom > listRect.bottom) {
            next.scrollIntoView({ block: "nearest" });
          }
        }
        activeTocId = id;
      }

      function updateActiveFromScroll() {
        if (!state.tocHeadings || state.tocHeadings.length === 0) return;
        const scrollTop = viewerBodyEl.scrollTop;
        const containerTop = viewerBodyEl.getBoundingClientRect().top;
        let current = state.tocHeadings[0];
        for (const heading of state.tocHeadings) {
          const headingTop = heading.getBoundingClientRect().top - containerTop;
          if (headingTop <= 50) {
            current = heading;
          } else {
            break;
          }
        }
        if (current && current.id) {
          setActiveToc(current.id);
        }
      }

      function handleContentScroll() {
        if (scrollRaf) return;
        scrollRaf = requestAnimationFrame(() => {
          scrollRaf = null;
          updateActiveFromScroll();
        });
      }

      function buildToc(container) {
        tocListEl.innerHTML = "";
        if (!container) return;
        const headings = Array.from(container.querySelectorAll("h1, h2, h3"));
        state.tocHeadings = headings;
        if (headings.length === 0) {
          const empty = document.createElement("li");
          empty.className = "toc-item";
          empty.textContent = "No headings";
          tocListEl.appendChild(empty);
          return;
        }

        const used = new Map();
        headings.forEach((heading) => {
          const level = Number(heading.tagName.replace("H", ""));
          let base = heading.id || slugify(heading.textContent || "section");
          const count = used.get(base) || 0;
          used.set(base, count + 1);
          if (count > 0) {
            base = `${base}-${count}`;
          }
          heading.id = base;

          const item = document.createElement("li");
          item.className = `toc-item level-${level}`;
          item.dataset.tocId = base;
          item.textContent = heading.textContent || "Untitled";
          item.addEventListener("click", () => {
            const target = container.querySelector(`#${CSS.escape(base)}`);
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          });
          tocListEl.appendChild(item);
        });
        updateActiveFromScroll();
      }

      filterEl.addEventListener("input", (event) => {
        state.filter = event.target.value || "";
        renderList();
      });

      editToggleEl.addEventListener("click", () => {
        if (!state.selectedId) return;
        setEditMode(true);
      });

      cancelEl.addEventListener("click", () => {
        setEditMode(false);
        contentEl.innerHTML = state.currentHtml;
        buildToc(contentEl);
      });

      saveEl.addEventListener("click", () => {
        saveFile();
      });

      contentEl.addEventListener("input", () => {
        if (state.isEditing) {
          scheduleTocRefresh();
          updateWordCount();
        }
      });

      viewerBodyEl.addEventListener("scroll", handleContentScroll);

      window.addEventListener("resize", () => {
        updateActiveFromScroll();
      });

      window.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "s") {
          if (state.isEditing) {
            event.preventDefault();
            saveFile();
          }
        }
      });

      // Theme toggle listeners
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setTheme(btn.dataset.theme);
        });
      });

      // Initialize theme buttons
      updateThemeButtons(getStoredTheme());

      // Formatting toolbar functions
      function execFormat(cmd, value = null) {
        contentEl.focus();
        document.execCommand(cmd, false, value);
        scheduleTocRefresh();
        updateWordCount();
      }

      function formatHeading(tag) {
        contentEl.focus();
        if (tag === 'p') {
          document.execCommand('formatBlock', false, 'p');
          headingLabel.textContent = 'Body';
        } else {
          document.execCommand('formatBlock', false, tag);
          headingLabel.textContent = tag.toUpperCase();
        }
        scheduleTocRefresh();
      }

      function insertLink() {
        const url = prompt('Enter URL:', 'https://');
        if (url) {
          document.execCommand('createLink', false, url);
        }
      }

      function insertCodeBlock() {
        const code = document.createElement('pre');
        const codeInner = document.createElement('code');
        codeInner.textContent = 'code here';
        code.appendChild(codeInner);

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(code);
          range.setStartAfter(code);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }

      function insertHorizontalRule() {
        document.execCommand('insertHorizontalRule', false, null);
      }

      function insertTable() {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        const headerRow = document.createElement('tr');
        const bodyRow = document.createElement('tr');

        for (let i = 0; i < 3; i++) {
          const th = document.createElement('th');
          th.textContent = `Header ${i + 1}`;
          headerRow.appendChild(th);

          const td = document.createElement('td');
          td.textContent = `Cell ${i + 1}`;
          bodyRow.appendChild(td);
        }

        thead.appendChild(headerRow);
        tbody.appendChild(bodyRow);
        table.appendChild(thead);
        table.appendChild(tbody);

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(table);
          range.setStartAfter(table);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }

      function closeAllDropdowns() {
        document.querySelectorAll('.format-dropdown').forEach(d => d.classList.remove('open'));
      }

      // Format button clicks
      formatToolbarEl.querySelectorAll('.format-btn[data-cmd]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const cmd = btn.dataset.cmd;
          const value = btn.dataset.value || null;
          execFormat(cmd, value);
        });
      });

      // Heading dropdown
      headingDropdown.querySelector('.format-dropdown-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllDropdowns();
        headingDropdown.classList.toggle('open');
      });

      headingDropdown.querySelectorAll('.format-dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
          formatHeading(item.dataset.heading);
          closeAllDropdowns();
        });
      });

      // Insert dropdown
      insertDropdown.querySelector('.format-dropdown-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllDropdowns();
        insertDropdown.classList.toggle('open');
      });

      insertDropdown.querySelectorAll('.format-dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
          const insert = item.dataset.insert;
          if (insert === 'code') insertCodeBlock();
          else if (insert === 'hr') insertHorizontalRule();
          else if (insert === 'table') insertTable();
          closeAllDropdowns();
          scheduleTocRefresh();
        });
      });

      // Link button
      linkBtn.addEventListener('click', () => {
        insertLink();
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        closeAllDropdowns();
      });

      // Keyboard shortcuts for formatting
      contentEl.addEventListener('keydown', (event) => {
        if (!state.isEditing) return;

        if (event.metaKey || event.ctrlKey) {
          switch (event.key.toLowerCase()) {
            case 'b':
              event.preventDefault();
              execFormat('bold');
              break;
            case 'i':
              event.preventDefault();
              execFormat('italic');
              break;
            case 'k':
              event.preventDefault();
              insertLink();
              break;
          }
        }
      });

      // Width toggle
      function setContentWidth(mode) {
        contentEl.classList.remove('fixed-width', 'full-width');
        contentEl.classList.add(mode + '-width');
        widthToggle.querySelectorAll('.width-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.width === mode);
        });
        localStorage.setItem('skimmd-width', mode);
      }

      widthToggle.querySelectorAll('.width-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setContentWidth(btn.dataset.width);
        });
      });

      // Initialize width from localStorage
      const savedWidth = localStorage.getItem('skimmd-width') || 'fixed';
      setContentWidth(savedWidth);

      // Focus mode
      function toggleFocusMode() {
        const isEnabled = document.body.classList.toggle('focus-mode');
        if (isEnabled) {
          contentEl.focus();
        }
      }

      focusBtn.addEventListener('click', () => {
        toggleFocusMode();
      });

      // Escape key to exit focus mode or close modal
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (fileModal.classList.contains('open')) {
            closeFileModal();
          } else if (document.body.classList.contains('focus-mode')) {
            document.body.classList.remove('focus-mode');
          }
        }
      });

      // File browser modal
      function openFileModal() {
        fileModal.classList.add('open');
        pathInput.value = '';
        pathInput.focus();
        browsePath(state.browserPath || '');
      }

      function closeFileModal() {
        fileModal.classList.remove('open');
      }

      async function browsePath(dirPath) {
        try {
          const res = await fetch(`/api/browse?path=${encodeURIComponent(dirPath)}`);
          if (!res.ok) {
            const err = await res.json();
            console.error('Browse error:', err.error);
            return;
          }
          const data = await res.json();
          state.browserPath = data.current;
          browserPathEl.textContent = data.current;
          renderBrowserList(data.items, data.parent);
        } catch (err) {
          console.error('Browse error:', err);
        }
      }

      function renderBrowserList(items, parentPath) {
        browserListEl.innerHTML = '';

        if (items.length === 0) {
          const empty = document.createElement('li');
          empty.className = 'browser-empty';
          empty.textContent = 'No markdown files in this folder';
          browserListEl.appendChild(empty);
          return;
        }

        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'browser-item' + (item.isDirectory ? ' folder' : '');

          const icon = item.isDirectory
            ? '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>'
            : '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>';

          li.innerHTML = `${icon}<span class="browser-item-name">${item.name}</span>`;

          li.addEventListener('click', () => {
            if (item.isDirectory) {
              browsePath(item.path);
            } else {
              openExternalFile(item.path);
              closeFileModal();
            }
          });

          browserListEl.appendChild(li);
        });
      }

      async function openExternalFile(filePath) {
        try {
          const res = await fetch(`/api/open-file?path=${encodeURIComponent(filePath)}`);
          if (!res.ok) {
            alert('Failed to open file');
            return;
          }
          const data = await res.json();

          // Clear selection from file list
          state.selectedId = null;
          state.openedFile = {
            path: data.path,
            name: data.name,
          };

          renderList();

          state.currentContent = data.content || '';
          state.currentHtml = data.html || '';
          contentEl.classList.remove('empty');
          contentEl.innerHTML = state.currentHtml;
          editToggleEl.disabled = false;

          // Update header
          const displayName = data.name.replace(/\.md$/i, '');
          docTitleEl.textContent = displayName || 'Untitled';
          docPathEl.textContent = data.path;
          document.title = displayName ? `${displayName} - skimmd` : 'skimmd';

          if (data.metadata) {
            const updated = new Date(data.metadata.modifiedAt).toLocaleString();
            metaEl.textContent = `Last updated ${updated}`;
          }

          buildToc(contentEl);
          setEditMode(false);
        } catch (err) {
          console.error('Open file error:', err);
          alert('Failed to open file');
        }
      }

      async function saveExternalFile() {
        if (!state.openedFile) return;
        const html = contentEl.innerHTML;
        saveEl.disabled = true;
        try {
          const res = await fetch(`/api/open-file?path=${encodeURIComponent(state.openedFile.path)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ html }),
          });
          if (!res.ok) {
            alert('Failed to save file');
            return;
          }
          const data = await res.json();
          state.currentContent = data.content || '';
          state.currentHtml = data.html || html;
          contentEl.innerHTML = state.currentHtml;
          if (data.metadata) {
            const updated = new Date(data.metadata.modifiedAt).toLocaleString();
            metaEl.textContent = `Last updated ${updated}`;
          }
          buildToc(contentEl);
          setEditMode(false);
        } finally {
          saveEl.disabled = false;
        }
      }

      // Open file button
      openFileBtnEl.addEventListener('click', openFileModal);

      // Modal close
      modalCloseBtn.addEventListener('click', closeFileModal);
      fileModal.addEventListener('click', (e) => {
        if (e.target === fileModal) closeFileModal();
      });

      // Path input
      pathInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const value = pathInput.value.trim();
          if (value) {
            // Check if it looks like a file path
            if (value.endsWith('.md') || value.endsWith('.markdown') || value.endsWith('.txt')) {
              openExternalFile(value);
              closeFileModal();
            } else {
              browsePath(value);
            }
          }
        }
      });

      pathGoBtn.addEventListener('click', () => {
        const value = pathInput.value.trim();
        if (value) {
          if (value.endsWith('.md') || value.endsWith('.markdown') || value.endsWith('.txt')) {
            openExternalFile(value);
            closeFileModal();
          } else {
            browsePath(value);
          }
        }
      });

      // Browser back button
      browserBackBtn.addEventListener('click', () => {
        const current = state.browserPath;
        const parent = current.split('/').slice(0, -1).join('/') || '/';
        browsePath(parent);
      });

      // Live reload via Server-Sent Events
      function setupLiveReload() {
        const eventSource = new EventSource('/api/events');

        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'reload') {
              console.log('File changed:', data.file);
              // If we're not editing, reload the current file
              if (!state.isEditing && state.selectedId) {
                // Check if the changed file is the current file
                const changedFile = data.file.replace(/\\/g, '/');
                if (state.selectedId === changedFile || changedFile.endsWith(state.selectedId)) {
                  openFile(state.selectedId);
                }
              }
              // Always refresh the file list in case files were added/removed
              fetchFiles().then(() => {
                // Re-select current file to update the list highlighting
                if (state.selectedId) {
                  renderList();
                }
              });
            }
          } catch (err) {
            console.error('Live reload error:', err);
          }
        };

        eventSource.onerror = () => {
          // Reconnect after a delay if connection is lost
          eventSource.close();
          setTimeout(setupLiveReload, 2000);
        };
      }

      setupLiveReload();
      fetchConfig();
      fetchFiles();
    </script>
  </body>
</html>
